; MASM Example - Enumerate Windows Registry Values
; includes
include \masm32\include\masm32rt.inc
include \masm32\include\advapi32.inc
includelib \masm32\lib\advapi32.lib

.data

target_key db "SOFTWARE\Microsoft\Windows\CurrentVersion\Run", 0
hkey dd ?

value_index dd 0 ; The index of the value we want to retrieve

size_of_registry_value dd ?
size_of_registry_data dd ?
data_type_registry dd ?
registry_value db 260 dup (?)
registry_data db 260 dup (?)

.code

start:
    ; Open the registry key
    push offset hkey
    push offset target_key
    push offset HKEY_CURRENT_USER
    call RegOpenKey

    ; The size of the buffer for the registry value and data.
    mov size_of_registry_value, 256
    mov size_of_registry_data, 256

    ; Loop to print all values.
    _next_value:
        ; Initialize size of registry value and data
        mov size_of_registry_value, 256
        mov size_of_registry_data, 256

        ; Attempt to retrieve a value.
        push offset size_of_registry_data
        push offset registry_data
        push offset data_type_registry
        push 0
        push offset size_of_registry_value
        push offset registry_value
        push dword ptr [value_index] ; index of value
        push hkey
        call RegEnumValue

        ; Check if the operation was successful
        cmp eax, ERROR_SUCCESS
        jne _cleanup ; If no more values could be retrieved, clean up and exit.

        ; The value was retrieved successfully. Print it.
        invoke StdOut, offset registry_value
        inc dword ptr [value_index] ; increment the index for the next iteration
        jmp _next_value ; go to the next value

    _cleanup:
        ; Close the registry key when we're done with it.
        invoke RegCloseKey, hkey
    exit:
        ; Exit the process.
        invoke ExitProcess, 0
end start




